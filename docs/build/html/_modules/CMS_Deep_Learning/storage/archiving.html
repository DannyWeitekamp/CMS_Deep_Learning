

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CMS_Deep_Learning.storage.archiving &#8212; CMS_Deep_Learning 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CMS_Deep_Learning 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CMS_Deep_Learning.storage.archiving</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">archive.py</span>
<span class="sd">A system for archiving keras trials and input data</span>
<span class="sd">Author: Danny Weitekamp</span>
<span class="sd">e-mail: dannyweitekamp@gmail.com</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>



<div class="viewcode-block" id="Storable"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable">[docs]</a><span class="k">class</span> <span class="nc">Storable</span><span class="p">(</span> <span class="nb">object</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object that we can hash, archive as a json String, and reconstitute&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize the Storable&#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">recurse_store</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Storable</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">(</span><span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">recurse_store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashcode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_hashcode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="Storable.hash"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.hash">[docs]</a>    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rehash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_seed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute the hashcode for the Storable from its json string&#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashcode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hashcode</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_hashable</span><span class="p">())</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">)):</span>
                <span class="n">temp_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen_hashcode</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_hashable</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">temp_seed</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashcode</span></div>
<div class="viewcode-block" id="Storable.gen_hash"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.gen_hash">[docs]</a>    <span class="k">def</span> <span class="nf">gen_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_hashcode</span></div>
<div class="viewcode-block" id="Storable.get_path"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Gets the archive (blob) path from its hash&#39;&#39;&#39;</span>
        <span class="n">hashcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span>
        <span class="n">expanded_archive_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">get_blob_path</span><span class="p">(</span><span class="n">hashcode</span><span class="o">=</span><span class="n">hashcode</span><span class="p">,</span> <span class="n">archive_dir</span><span class="o">=</span><span class="n">expanded_archive_dir</span><span class="p">)</span> </div>
<div class="viewcode-block" id="Storable.to_json"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must implement a function that returns the json string corresponding to the Storable&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Should have implemented to_json&quot;</span> <span class="p">)</span></div>
<div class="viewcode-block" id="Storable.to_hashable"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.to_hashable">[docs]</a>    <span class="k">def</span> <span class="nf">to_hashable</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must implement a function that returns a hashable string corresponding to the Storable&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Should have implemented to_hashable&quot;</span> <span class="p">)</span></div>
<div class="viewcode-block" id="Storable.write"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Must implement a function that write the Storable&#39;s json sring to its archive (blob) path&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Should have implemented write&quot;</span> <span class="p">)</span></div>
<div class="viewcode-block" id="Storable.remove_from_archive"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.remove_from_archive">[docs]</a>    <span class="k">def</span> <span class="nf">remove_from_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes all the data that the Storable has archived in its archive path&#39;&#39;&#39;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="n">blob_dir</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">split_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span> 
        <span class="n">parentfolder</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span><span class="s1">&#39;blob&#39;</span><span class="p">,</span> <span class="n">blob_dir</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">parentfolder</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parentfolder</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">parentfolder</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="Storable.read_record"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.read_record">[docs]</a>    <span class="k">def</span> <span class="nf">read_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the dictionary containing all the record values for this trial &#39;&#39;&#39;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">read_json_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="s2">&quot;record.json&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span> <span class="n">record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">record</span></div>

<div class="viewcode-block" id="Storable.write_record"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.write_record">[docs]</a>    <span class="k">def</span> <span class="nf">write_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the dictionary containing all the record values for this trial &#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;obj must be type dict, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">write_json_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span><span class="s1">&#39;record.json&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="Storable.remove_from_record"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.remove_from_record">[docs]</a>    <span class="k">def</span> <span class="nf">remove_from_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove a key from the record. Returns 1 if sucessfully removed 0 if does not exist&#39;&#39;&#39;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">record</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Storable.output_as_dir"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.output_as_dir">[docs]</a>    <span class="k">def</span> <span class="nf">output_as_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">output_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">output_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">isGenerator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raiseError</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="k">def</span> <span class="nf">_assertPath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_dirFromData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data_paths</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raiseError</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">cop</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">symlink</span> <span class="k">if</span> <span class="n">symlink</span> <span class="k">else</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span>
            <span class="n">_assertPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">archive_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="s2">&quot;archive.h5&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_paths</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archive_paths</span><span class="p">):</span>
                <span class="n">p</span>  <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%04i</span><span class="s2">.h5&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
                    <span class="kn">import</span> <span class="nn">warnings</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data does not exist </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">raiseError</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">()</span>
                <span class="n">cop</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">output_model</span><span class="p">):</span>
            <span class="n">_assertPath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;model.json&quot;</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">if</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">model_from_json</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">warnings</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MODEL JSON DOESN&#39;T LOAD </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">raiseError</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">IOError</span><span class="p">()</span>
            <span class="c1"># write_json_obj(self.model, directory, &quot;model.json&quot;)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">output_weights</span><span class="p">):</span>
            <span class="n">cop</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">symlink</span> <span class="k">if</span> <span class="n">symlink</span> <span class="k">else</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span>
            <span class="n">cop</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span><span class="s2">&quot;weights.h5&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;weights.h5&quot;</span><span class="p">]))</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">output_train</span><span class="p">):</span>
            <span class="n">train_dir</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;trian&quot;</span><span class="p">])</span>
            <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">isGenerator</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_dirFromData</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">raiseError</span><span class="o">=</span><span class="n">raiseError</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">output_val</span><span class="p">):</span>
            <span class="n">val_dir</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">])</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">isGenerator</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_dirFromData</span><span class="p">(</span><span class="n">val_dir</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="n">check</span><span class="p">,</span> <span class="n">raiseError</span><span class="o">=</span><span class="n">raiseError</span><span class="p">)</span></div>

<div class="viewcode-block" id="Storable.get_all_paths"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.get_all_paths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a list of all the blob paths of the Storables in the given archive_dir&#39;&#39;&#39;</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">archive_dir</span><span class="p">,</span><span class="s2">&quot;blob&quot;</span><span class="p">,</span><span class="s2">&quot;*&quot;</span><span class="p">]))</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span><span class="p">)</span>
            <span class="n">paths</span> <span class="o">+=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">paths</span></div>

<div class="viewcode-block" id="Storable.get_all_records"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.get_all_records">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_records</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a dicionary of all the records in the archive_dir keyed by their hashcodes&#39;&#39;&#39;</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">hashcode</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hashcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hashcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">read_json_obj</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;record.json&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">record</span> <span class="o">!=</span> <span class="p">{}):</span>
                <span class="n">records</span><span class="p">[</span><span class="n">hashcode</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
        <span class="k">return</span> <span class="n">records</span></div>

<div class="viewcode-block" id="Storable.find"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.Storable.find">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="n">hashcode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the archived DataProcedure with the given hashcode or None if one is not found&#39;&#39;&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">KerasTrial</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;trial&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">DataProcedure</span><span class="p">)):</span>
            <span class="n">name</span>  <span class="o">=</span> <span class="s2">&quot;procedure&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">get_blob_path</span><span class="p">(</span><span class="n">hashcode</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">),</span> <span class="n">name</span> <span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="p">)</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">json_str</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">hashcode</span> <span class="o">=</span> <span class="n">hashcode</span>
            <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully loaded &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.json at &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to load &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.json at &#39;</span>  <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div></div>

<div class="viewcode-block" id="DataProcedure"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure">[docs]</a><span class="k">class</span> <span class="nc">DataProcedure</span><span class="p">(</span><span class="n">Storable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A wrapper for archiving the results of data grabbing and preprocessing functions of the type X,Y getData where are X is the training</span>
<span class="sd">        data and Y contains the labels/targets for each entry&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="n">archive_on_get_data</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">]):</span>
        <span class="n">Storable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_archive_dir must be str, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">archive_on_get_data</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;archive_getData must be bool, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">archive_on_get_data</span><span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;func must be function, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_module</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kargs</span> <span class="o">=</span> <span class="n">kargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_getData</span> <span class="o">=</span> <span class="n">archive_on_get_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span> <span class="o">=</span> <span class="n">data_keys</span>


<div class="viewcode-block" id="DataProcedure.set_encoder"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.set_encoder">[docs]</a>    <span class="k">def</span> <span class="nf">set_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set the json encoder for the procedure in case its arguements are not json encodable&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span></div>

    <span class="k">def</span> <span class="nf">_gen_jsonable_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;archive_dir&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;encoder&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;decoder&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;decoder&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;hashcode&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="DataProcedure.to_hashable"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.to_hashable">[docs]</a>    <span class="k">def</span> <span class="nf">to_hashable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Gets a string that uniquely defines an object as far as its model, complilation, and training parameters are concerned&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_jsonable_dict</span><span class="p">()</span>
        <span class="c1">#Don&#39;t hash on verbose or verbosity if they are in the function</span>
        <span class="k">if</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kargs&quot;</span><span class="p">,</span> <span class="p">[])):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kargs&#39;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s2">&quot;verbosity&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kargs&quot;</span><span class="p">,</span> <span class="p">[])):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kargs&#39;</span><span class="p">][</span><span class="s2">&quot;verbosity&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataProcedure.to_json"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the json string for the Procedure with only its essential characteristics&#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_jsonable_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataProcedure.write"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the json string for the procedure to its directory&#39;&#39;&#39;</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="n">write_object</span><span class="p">(</span><span class="n">blob_path</span><span class="p">,</span> <span class="s1">&#39;procedure.json&#39;</span><span class="p">,</span> <span class="n">json_str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataProcedure.is_archived"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.is_archived">[docs]</a>    <span class="k">def</span> <span class="nf">is_archived</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns True if this procedure is already archived&#39;&#39;&#39;</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">blob_path</span><span class="p">,</span><span class="s2">&quot;archive.h5&quot;</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DataProcedure.archive"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.archive">[docs]</a>    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span><span class="c1">#,data_keys=[&quot;X&quot;, &quot;Y&quot;]):</span>
        <span class="sd">&#39;&#39;&#39;Store the DataProcedure in a directory computed by its hashcode&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot archive DataProcedure that includes NoneType&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset with </span><span class="si">%r</span><span class="s2"> groups cannot be named with data_keys </span><span class="si">%r</span><span class="s2"> with </span><span class="si">%r</span><span class="s2"> keys; </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">()))</span>
        
        <span class="c1"># if((not X is None) and (not Y is None)):</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">blob_path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">blob_path</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">blob_path</span><span class="p">,</span> <span class="s1">&#39;procedure.json&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="c1"># if(isinstance(X, list) == False): X = [X]</span>
        <span class="c1"># if(isinstance(Y, list) == False): Y = [Y]</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">blob_path</span><span class="p">,</span> <span class="s2">&quot;archive.h5&quot;</span><span class="p">])</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">D</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_keys</span><span class="p">):</span>
            <span class="n">h5f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
                <span class="n">h5f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># h5f.create_group(&quot;Y&quot;)</span>
        <span class="c1"># for i, y in enumerate(Y):</span>
        <span class="c1">#     h5f.create_dataset(&#39;Y/&#39;+str(i), data=y)</span>
        
        <span class="n">h5f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">#TODO: this is a really backward way of doing this</span>
        <span class="n">jstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jstr</span><span class="p">)</span>

        <span class="n">record_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">record_dict</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
        <span class="n">record_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func_module&#39;</span><span class="p">]</span>
        <span class="n">record_dict</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
        <span class="n">record_dict</span><span class="p">[</span><span class="s1">&#39;kargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kargs&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">record_dict</span><span class="p">)</span></div>
                        
        
    <span class="k">def</span> <span class="nf">_checkData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_keys</span><span class="p">):</span>
        <span class="c1"># if(not len(data) == len(data_keys)):</span>
        <span class="c1">#     raise ValueError(&quot;getData returned too many arguments expected %r got %r&quot; % len(out))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data type expected list but got </span><span class="si">%r</span><span class="s2"> in key </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]))</span>

<div class="viewcode-block" id="DataProcedure.load_hdf5_data"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.load_hdf5_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_hdf5_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; https://github.com/duanders/mpi_learn -- train/data.py</span>
<span class="sd">            Returns a numpy array or (possibly nested) list of numpy arrays </span>
<span class="sd">            corresponding to the group structure of the input HDF5 data.</span>
<span class="sd">            If a group has more than one key, we give its datasets alphabetically by key&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_hdf5_data</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">out</span></div>
        
<div class="viewcode-block" id="DataProcedure.get_data"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">data_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Apply the DataProcedure returning X,Y from the archive or generating them from func&#39;&#39;&#39;</span>
        <span class="c1"># if verbose == 1: raise ValueError()</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_archived</span><span class="p">()</span> <span class="ow">and</span> <span class="n">redo</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">h5_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="s1">&#39;archive.h5&#39;</span><span class="p">]),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="n">data_keys</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
                    <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_hdf5_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DataProcedure results </span><span class="si">%r</span><span class="s2"> read from archive&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">h5_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span> <span class="n">h5_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load archive </span><span class="si">%r</span><span class="s2"> running from scratch&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="n">archive</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prep_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_module</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">prep_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kargs</span><span class="p">)</span>
            
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkData</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">data_keys</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_getData</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">archive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ARCHIVE SUCCESSFUL </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span>
                
            <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">archive_getData</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">archive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;getData did not return (X,Y,...) or Generator got types </span><span class="si">%r</span><span class="s2">&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span> <span class="p">))</span>
            
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="DataProcedure.summary"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the summary for the DataProcedure as a string&#39;&#39;&#39;</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;DataProcedure (</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">str_args</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
        <span class="n">str_kargs</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kargs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kargs</span><span class="p">])</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">str_args</span><span class="p">,</span> <span class="n">str_kargs</span><span class="p">])</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_module</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">+</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">arguments</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">out_str</span></div>

<div class="viewcode-block" id="DataProcedure.get_func"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.get_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a function from its name and module path&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;from &quot;</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span>  <span class="s2">&quot; import &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; as prep_func&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataProcedure function </span><span class="si">%r</span><span class="s2"> does not exist in </span><span class="si">%r</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                For best results functions should be importable and not locally defined.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prep_func&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataProcedure.from_json"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">archive_dir</span> <span class="p">,</span><span class="n">json_str</span><span class="p">,</span> <span class="n">arg_decode_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  
        <span class="sd">&#39;&#39;&#39;Get a DataProcedure object from its json string&#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func_module&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kargs</span><span class="p">,</span><span class="n">data_keys</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kargs&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;data_keys&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">islist</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">islist</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="c1"># print(type(a), type(obj))</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;DataProcedure&quot;</span><span class="p">):</span>
                            <span class="n">arg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">arg_decode_func</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">islist</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">if</span><span class="p">(</span><span class="n">arg_decode_func</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># print(&#39;arg_decode_func_ENABLED:&#39;, arg_decode_func.__name__)</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kargs</span> <span class="o">=</span> <span class="n">arg_decode_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>

        <span class="n">archive_getData</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;archive_getData&#39;</span><span class="p">]</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">archive_getData</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kargs</span><span class="p">,</span><span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">temp</span><span class="p">):</span>
            <span class="n">dp</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
            <span class="n">dp</span><span class="o">.</span><span class="n">func_module</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;func_module&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dp</span></div>

<div class="viewcode-block" id="DataProcedure.get_all_paths"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.DataProcedure.get_all_paths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Gets the blob paths of all of the DataProcedures in the archive_dir&#39;&#39;&#39;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">Storable</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span> <span class="p">,</span> <span class="s2">&quot;procedure.json&quot;</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="n">paths</span></div></div>

<span class="c1"># INPUT_DEFAULTS ={</span>
<span class="c1">#                 &quot;metrics&quot; : [],</span>
<span class="c1">#                 &quot;sample_weight_mode&quot; : None,</span>

<span class="c1">#                 &quot;validation_split&quot; : 0.0,</span>
<span class="c1">#                 &quot;batch_size&quot; : 32,</span>
<span class="c1">#                 &quot;nb_epoch&quot; : 10,</span>
<span class="c1">#                 &quot;callbacks&quot; : [],</span>

<span class="c1">#                 &quot;shuffle&quot; : True,</span>
<span class="c1">#                 &quot;class_weight&quot; : None,</span>
<span class="c1">#                 &quot;sample_weight&quot; : None,</span>

<span class="c1">#                 &quot;nb_val_samples&quot; : None,</span>
<span class="c1">#                 &quot;max_q_size&quot; : 10,</span>
<span class="c1">#                 &quot;nb_worker&quot; :1,</span>
<span class="c1">#                 &quot;pickle_safe&quot; : False</span>
<span class="c1">#                 }</span>
<span class="n">INPUT_DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;seed&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;train_procedure&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;samples_per_epoch&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;validation_split&quot;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;val_procedure&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;nb_val_samples&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

    <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;loss&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;metrics&quot;</span><span class="p">:[],</span>
    <span class="s2">&quot;sample_weight_mode&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>

    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;nb_epoch&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;callbacks&quot;</span><span class="p">:[],</span>
    
    <span class="s2">&quot;max_q_size&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;nb_worker&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pickle_safe&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>

    <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;class_weight&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;sample_weight&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">REQUIRED_INPUTS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">])</span>
<span class="n">HASH_SPLIT_POINT</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="KerasTrial"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial">[docs]</a><span class="k">class</span> <span class="nc">KerasTrial</span><span class="p">(</span><span class="n">Storable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An archivable object representing a machine learning trial in keras&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">archive_dir</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;trial&#39;</span><span class="p">,</span>
    				<span class="c1"># model=None,</span>
        <span class="c1">#             train_procedure=None,</span>
        <span class="c1">#             samples_per_epoch=None,</span>
        <span class="c1">#             validation_split=0.0,</span>
        <span class="c1">#             val_procedure=None,</span>
        <span class="c1">#             nb_val_samples=None,</span>

        <span class="c1">#             optimizer=None,</span>
        <span class="c1">#             loss=None,</span>
        <span class="c1">#             metrics=[],</span>
        <span class="c1">#             sample_weight_mode=None,</span>

        <span class="c1">#             batch_size=32,</span>
        <span class="c1">#             nb_epoch=10,</span>
        <span class="c1">#             callbacks=[],</span>
                    
        <span class="c1">#             max_q_size=10,</span>
        <span class="c1">#             nb_worker=1,</span>
        <span class="c1">#             pickle_safe=False,</span>

        <span class="c1">#             shuffle=True,</span>
        <span class="c1">#             class_weight=None,</span>
        <span class="c1">#             sample_weight=None,</span>
                    <span class="o">**</span><span class="n">kargs</span>
                <span class="p">):</span>
    	
        <span class="n">Storable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># if(archive_dir[len(archive_dir)-1] != &quot;/&quot;):</span>
        <span class="c1">#     archive_dir = archive_dir + &quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">INPUT_DEFAULTS</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">):</span>
                <span class="n">kargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPUT_DEFAULTS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_train</span><span class="p">(</span><span class="n">train_procedure</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;train_procedure&quot;</span><span class="p">],</span> <span class="n">samples_per_epoch</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;samples_per_epoch&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_validation</span><span class="p">(</span><span class="n">validation_split</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;validation_split&quot;</span><span class="p">],</span>
                            <span class="n">val_procedure</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;val_procedure&quot;</span><span class="p">],</span>
                            <span class="n">nb_val_samples</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;nb_val_samples&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_compilation</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">],</span>
                             <span class="n">loss</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">],</span>
                             <span class="n">metrics</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">],</span>
                             <span class="n">sample_weight_mode</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;sample_weight_mode&quot;</span><span class="p">])</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span>
                     <span class="n">nb_epoch</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;nb_epoch&quot;</span><span class="p">],</span>
                     <span class="n">callbacks</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;callbacks&quot;</span><span class="p">],</span>
                     <span class="n">shuffle</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;shuffle&quot;</span><span class="p">],</span>
                     <span class="n">class_weight</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;class_weight&quot;</span><span class="p">],</span>
                     <span class="n">sample_weight</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;sample_weight&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_fit_generator</span><span class="p">(</span><span class="n">nb_epoch</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;nb_epoch&quot;</span><span class="p">],</span>
                               <span class="n">callbacks</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;callbacks&quot;</span><span class="p">],</span>
                               <span class="n">class_weight</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;class_weight&quot;</span><span class="p">],</span>
                               <span class="n">max_q_size</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;max_q_size&quot;</span><span class="p">],</span>
                               <span class="n">nb_worker</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;nb_worker&quot;</span><span class="p">],</span>
                               <span class="n">pickle_safe</span><span class="o">=</span><span class="n">kargs</span><span class="p">[</span><span class="s2">&quot;pickle_safe&quot;</span><span class="p">])</span>
    

<div class="viewcode-block" id="KerasTrial.set_model"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set the model used by the trial (either the object or derived json string)&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">keras.engine.training</span> <span class="k">import</span> <span class="n">Model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_prep_procedure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">procedure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A helper function that makes sure that DataProcedures are stored as json strings for easy serialization&#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">procedure</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">procedure</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">procedure</span> <span class="o">=</span> <span class="p">[</span><span class="n">procedure</span><span class="p">]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procedure</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DataProcedure</span><span class="p">)):</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">_procedure must be DataProcedure, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">l</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="KerasTrial.set_train"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_train">[docs]</a>    <span class="k">def</span> <span class="nf">set_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">train_procedure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples_per_epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the training data for the trial&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_procedure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_procedure</span><span class="p">(</span><span class="n">train_procedure</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_epoch</span> <span class="o">=</span> <span class="n">samples_per_epoch</span></div>
    
<div class="viewcode-block" id="KerasTrial.set_validation"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_validation">[docs]</a>    <span class="k">def</span> <span class="nf">set_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">val_procedure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nb_val_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the training data for the trial&#39;&#39;&#39;</span>
    
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val_procedure</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">validation_split</span> <span class="o">=</span> <span class="n">val_procedure</span>
            <span class="n">val_procedure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">validation_split</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;validation_split must have type float, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">validation_split</span><span class="p">))</span>
        <span class="k">if</span><span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">nb_val_samples</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nb_val_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;nb_val_samples must have type int, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">nb_val_samples</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span> <span class="o">=</span> <span class="n">validation_split</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_procedure</span><span class="p">(</span><span class="n">val_procedure</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_val_samples</span> <span class="o">=</span> <span class="n">nb_val_samples</span></div>

<div class="viewcode-block" id="KerasTrial.set_compilation"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_compilation">[docs]</a>    <span class="k">def</span> <span class="nf">set_compilation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">optimizer</span><span class="p">,</span>
                        <span class="n">loss</span><span class="p">,</span>
                        <span class="n">metrics</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">sample_weight_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the compilation arguments for the trial&#39;&#39;&#39;</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weight_mode</span><span class="o">=</span><span class="n">sample_weight_mode</span></div>

<div class="viewcode-block" id="KerasTrial.set_fit"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_fit">[docs]</a>    <span class="k">def</span> <span class="nf">set_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">callbacks</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">class_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the fit arguments for the trial&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">CMS_Deep_Learning.callbacks</span> <span class="k">import</span> <span class="n">SmartCheckpoint</span>
        <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">Callback</span>

        <span class="n">strCallbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">SmartCheckpoint</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Callback</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">strCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encode_callback</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">strCallbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_epoch</span><span class="o">=</span><span class="n">nb_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span></div>

<div class="viewcode-block" id="KerasTrial.set_fit_generator"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.set_fit_generator">[docs]</a>    <span class="k">def</span> <span class="nf">set_fit_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">callbacks</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">class_weight</span><span class="o">=</span><span class="p">{},</span>
                          <span class="n">max_q_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">nb_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">pickle_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the fit arguments for the trial&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">CMS_Deep_Learning.callbacks</span> <span class="k">import</span> <span class="n">SmartCheckpoint</span>
        <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">Callback</span>

        <span class="n">strCallbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">SmartCheckpoint</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Callback</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">strCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encode_callback</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strCallbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="n">strCallbacks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nb_epoch</span><span class="o">=</span><span class="n">nb_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span>
 
        <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_q_size</span><span class="o">=</span><span class="n">max_q_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_worker</span><span class="o">=</span><span class="n">nb_worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_safe</span><span class="o">=</span><span class="n">pickle_safe</span></div>


    <span class="k">def</span> <span class="nf">_json_dict_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A helper function that generates a dictionary of values from a DataProcedure, omitting data that should not be stored or hashed on&#39;&#39;&#39;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;archive_dir&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;archive_dir&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;hashcode&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;hashcode&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;compiled_model&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">):</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;compiled_model&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_remove_dict_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes default values from trial for forward compatabilty&#39;&#39;&#39;</span>
        <span class="n">del_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">INPUT_DEFAULTS</span> <span class="ow">and</span> <span class="n">INPUT_DEFAULTS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">del_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">del_keys</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>
<div class="viewcode-block" id="KerasTrial.to_hashable"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.to_hashable">[docs]</a>    <span class="k">def</span> <span class="nf">to_hashable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Converts the trial to a hashable string &#39;&#39;&#39;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="c1">#Doesn&#39;t hash on the names of layers since they are random, and doesn&#39;t hash on keras_version</span>
            <span class="c1">#for forward and backward compatability.</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;name&quot;: &#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;name&quot;: &quot;[^&quot;]*&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;keras_version&quot;: &quot;[^&quot;]*&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        

        <span class="c1">#Doesn&#39;t hash on anything that is its default value for forward compatability. For example</span>
            <span class="c1"># if a parameter is added in a new version of keras and takes its default value then we </span>
            <span class="c1"># should not hash on it since otherwise the user will find that trails created in the </span>
            <span class="c1"># new version will hash differently than trials run with older versions of keras that </span>
            <span class="c1"># did not have the extra parameter, even though the user didn&#39;t change anything.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_dict_helper</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dict_defaults</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="k">return</span> <span class="n">json_str</span></div>

<div class="viewcode-block" id="KerasTrial.to_json"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Converts the trial to a json string &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_dict_helper</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="KerasTrial.compile"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loadweights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;Compiles the model set for this trial&#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">redo</span><span class="p">):</span> 
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">loadweights</span><span class="o">=</span><span class="n">loadweights</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span><span class="c1">#model_from_json(self.model)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                <span class="n">sample_weight_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_weight_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_model</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="k">def</span> <span class="nf">_generateCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A helper function that Generates a SmartCheckpoint used for storing the training history of a trial, plus more&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">CMS_Deep_Learning.callbacks</span> <span class="k">import</span> <span class="n">SmartCheckpoint</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decode_callback</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_acc&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;acc&#39;</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SmartCheckpoint</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">associated_trial</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">monitor</span><span class="o">=</span><span class="n">monitor</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                             <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">callbacks</span>

    <span class="k">def</span> <span class="nf">_history_to_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_store</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A helper function that Adds the important parts of the training history to the record&#39;&#39;&#39;</span>
        <span class="n">histDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">histDict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span> 
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">record_store</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">histDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">histDict</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_record</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>

<div class="viewcode-block" id="KerasTrial.fit"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">record_store</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;val_acc&quot;</span><span class="p">],</span><span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Runs model.fit(x_train, y_train) for the trial using the arguments passed to trial.setFit(...)&#39;&#39;&#39;</span>
        
        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateCallbacks</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                  <span class="n">nb_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_epoch</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
                  <span class="n">validation_split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span><span class="p">,</span>
                  <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span>
                  <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
                  <span class="n">sample_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_weight</span><span class="p">,</span>
                  <span class="n">initial_epoch</span><span class="o">=</span><span class="n">initial_epoch</span>
                  <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_to_record</span><span class="p">(</span><span class="n">record_store</span><span class="p">)</span></div>
       

<div class="viewcode-block" id="KerasTrial.fit_generator"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.fit_generator">[docs]</a>    <span class="k">def</span> <span class="nf">fit_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">record_store</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;val_acc&quot;</span><span class="p">],</span><span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Runs model.fit_generator(gen, samples) for the trial using the arguments passed to trial.setFit_Generator(...)&#39;&#39;&#39;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateCallbacks</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_epoch</span><span class="p">,</span>
                            <span class="n">nb_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_epoch</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
                            <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data</span><span class="p">,</span>
                            <span class="n">nb_val_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_val_samples</span><span class="p">,</span>
                            <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
                            <span class="n">max_q_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_q_size</span><span class="p">,</span>
                            <span class="n">nb_worker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_worker</span><span class="p">,</span>
                            <span class="n">pickle_safe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_safe</span><span class="p">,</span>
                            <span class="n">initial_epoch</span><span class="o">=</span><span class="n">initial_epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_to_record</span><span class="p">(</span><span class="n">record_store</span><span class="p">)</span></div>


<div class="viewcode-block" id="KerasTrial.write"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Writes the model&#39;s json string to its archive location&#39;&#39;&#39;</span> 
        <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="n">write_object</span><span class="p">(</span><span class="n">blob_path</span><span class="p">,</span> <span class="s1">&#39;trial.json&#39;</span><span class="p">,</span> <span class="n">json_str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">to_record</span><span class="p">({</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">},</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
                 

<div class="viewcode-block" id="KerasTrial.execute"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archiveTraining</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">archiveValidation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">train_arg_decode_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val_arg_decode_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Executes the trial, fitting the traing data in each DataProcedure in series&#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_procedure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot execute trial without DataProcedure&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
            <span class="n">train_procs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_procedure</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">train_procs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">train_procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_procs</span><span class="p">]</span>
            <span class="c1"># print(train_procs)</span>
            <span class="n">num_train</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;val_procedure must be single procedure, but got list&quot;</span><span class="p">)</span>
                <span class="n">val_proc</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg_decode_func</span><span class="o">=</span><span class="n">val_arg_decode_func</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val_proc</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="n">archiveValidation</span><span class="p">,</span> <span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">num_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_val_samples</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">train_procs</span><span class="p">:</span>
                <span class="n">train_proc</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">arg_decode_func</span><span class="o">=</span><span class="n">train_arg_decode_func</span><span class="p">)</span>

                <span class="n">train</span> <span class="o">=</span> <span class="n">train_proc</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="n">archiveTraining</span><span class="p">,</span><span class="n">data_keys</span><span class="o">=</span><span class="n">data_keys</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
                
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">history</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">history</span> <span class="o">=</span> <span class="p">{}</span> 
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="o">=</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_epoch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num_train</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_epoch</span>
                <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>  <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fit() cannot take generator for validation_data. Try fit_generator()&quot;</span><span class="p">)</span>
                    <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">train</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                    <span class="n">num_train</span> <span class="o">+=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="o">=</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_epoch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Traning DataProcedure returned useable type </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

            <span class="k">if</span><span class="p">(</span><span class="n">num_val</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">num_val</span> <span class="o">=</span> <span class="n">num_train</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span><span class="p">)</span>

            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
            <span class="n">dct</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;num_train&#39;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_train</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span><span class="p">)),</span>
                    <span class="s1">&#39;num_validation&#39;</span> <span class="p">:</span> <span class="n">num_val</span><span class="p">,</span>
                    <span class="s1">&#39;elapse_time&#39;</span> <span class="p">:</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elapse_time&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;last_epoch&#39;</span> <span class="p">:</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_epoch&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;start_time&#39;</span> <span class="p">:</span>  <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_time&#39;</span><span class="p">)</span>
                    <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_record</span><span class="p">(</span> <span class="n">dct</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trial </span><span class="si">%r</span><span class="s2"> Already Complete&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span></div>


<div class="viewcode-block" id="KerasTrial.test"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">test_proc</span><span class="p">,</span> <span class="n">test_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">archiveTraining</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="p">{},</span> <span class="n">max_q_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pickle_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">arg_decode_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">max_q_size</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># print(&quot;USING max_q_size: %r&quot; % self.max_q_size)</span>
            <span class="c1">#sys.stdout.flush()</span>
            <span class="n">max_q_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_q_size</span>

        <span class="n">record_loss</span><span class="p">,</span> <span class="n">record_acc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_from_record</span><span class="p">([</span><span class="s1">&#39;test_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;test_acc&#39;</span><span class="p">]</span> <span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">redo</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">record_loss</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">record_acc</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loadweights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_proc</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">test_proc</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_proc</span><span class="p">]</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_proc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;test_proc is empty: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_proc</span>

            <span class="n">sum_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">test_proc</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">arg_decode_func</span><span class="o">=</span><span class="n">arg_decode_func</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DataProcedure</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;test_proc expected DataProcedure, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

                <span class="n">test_data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">archive</span><span class="o">=</span><span class="n">archiveTraining</span><span class="p">)</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_samples</span><span class="p">,</span>
                                                        <span class="n">max_q_size</span><span class="o">=</span><span class="n">max_q_size</span><span class="p">,</span>
                                                        <span class="n">nb_worker</span><span class="o">=</span><span class="n">nb_worker</span><span class="p">,</span>
                                                        <span class="n">pickle_safe</span><span class="o">=</span><span class="n">pickle_safe</span><span class="p">)</span>
                    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">test_samples</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">test_data</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="p">]</span>
                    <span class="n">metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
                    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sum_metrics</span> <span class="o">==</span> <span class="p">[]):</span>
                    <span class="n">sum_metrics</span> <span class="o">=</span> <span class="n">metrics</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sum_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sum_metrics</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)]</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">test_proc</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sum_metrics</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_record</span><span class="p">({</span><span class="s1">&#39;test_loss&#39;</span> <span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;test_acc&#39;</span> <span class="p">:</span>  <span class="n">metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;num_test&#39;</span> <span class="p">:</span> <span class="n">n_samples</span><span class="p">},</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test Complete </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metrics</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test </span><span class="si">%r</span><span class="s2"> already Complete with test_loss: </span><span class="si">%0.4f</span><span class="s2">, test_acc: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">(),</span> <span class="n">record_loss</span><span class="p">,</span> <span class="n">record_acc</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">record_loss</span><span class="p">,</span> <span class="n">record_acc</span><span class="p">]</span></div>

<div class="viewcode-block" id="KerasTrial.get_train"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_train">[docs]</a>    <span class="k">def</span> <span class="nf">get_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_procedure</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="KerasTrial.get_val"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span><span class="p">]</span></div>
<div class="viewcode-block" id="KerasTrial.get_all_paths"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_all_paths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a list of all the blob paths of the KerasTrials in the given archive_dir&#39;&#39;&#39;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">Storable</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span> <span class="p">,</span> <span class="s2">&quot;trial.json&quot;</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="n">paths</span></div>


<div class="viewcode-block" id="KerasTrial.to_record"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.to_record">[docs]</a>    <span class="k">def</span> <span class="nf">to_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pushes a dictionary of values to the archive record for this trial&#39;&#39;&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;obj must be type dict, but got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">dct</span><span class="p">))</span>
 
        <span class="n">trial_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_record</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">append</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span><span class="p">((</span><span class="n">key</span> <span class="ow">in</span> <span class="n">trial_dict</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">trial_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">replace</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">trial_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trial_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">replace</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">trial_dict</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">trial_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">trial_dict</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="KerasTrial.get_from_record"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_from_record">[docs]</a>    <span class="k">def</span> <span class="nf">get_from_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a value from the record &#39;&#39;&#39;</span>
        <span class="n">recordDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recordDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">recordDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="KerasTrial.get_history"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the training history for this trial&#39;&#39;&#39;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">read_json_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="s2">&quot;history.json&quot;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">history</span> <span class="o">==</span> <span class="p">{}):</span>
            <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">history</span></div>

<div class="viewcode-block" id="KerasTrial.get_model"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loadweights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">custom_objects</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;Gets the model, optionally with the best set of weights&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">model_from_json</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">loadweights</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span><span class="s2">&quot;weights.h5&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="KerasTrial.is_complete"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.is_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return True if the trial has completed&#39;&#39;&#39;</span>
        <span class="n">blob_path</span> <span class="o">=</span> <span class="n">get_blob_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="n">history_path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">blob_path</span><span class="p">,</span><span class="s2">&quot;history.json&quot;</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_path</span><span class="p">)):</span>

            <span class="n">histDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="n">history_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="p">))</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stops&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="KerasTrial.summary"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">showName</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showDirectory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showRecord</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">showTraining</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showValidation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showCompilation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showFit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showModelPic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">showNoneType</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">squat</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Print a summary of the trial</span>
<span class="sd">            #Arguments:</span>
<span class="sd">                showName=False,showDirectory=False, showRecord=True, showTraining=True, showCompilation=True, showFit=True,</span>
<span class="sd">                 showModelPic=False, showNoneType=False -- Control what data is printed</span>
<span class="sd">                squat=True -- If False shows data on separate lines</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span>     
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">def</span> <span class="nf">_listIfNotNone</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">showNoneType</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">l</span>
        <span class="k">if</span><span class="p">(</span><span class="n">squat</span><span class="p">):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span>

        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;TRIAL SUMMARY (&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">showDirectory</span><span class="p">):</span> <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Directory: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">showName</span><span class="p">):</span> <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Name: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">def</span> <span class="nf">_getPairsFromKeys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">p_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">record</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p_keys</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="p">)</span>
                    <span class="k">del</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">if</span><span class="p">(</span><span class="n">showRecord</span><span class="p">):</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Record_Info:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_record</span><span class="p">()</span>
            
            <span class="k">if</span><span class="p">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">_getPairsFromKeys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;elapse_time&quot;</span><span class="p">,</span><span class="s2">&quot;last_epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">]),</span>
                            <span class="n">_getPairsFromKeys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;test_acc&quot;</span><span class="p">,</span><span class="s2">&quot;val_acc&quot;</span><span class="p">,</span> <span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="s2">&quot;test_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">])</span> <span class="p">,</span>
                            <span class="n">_getPairsFromKeys</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;num_train&quot;</span><span class="p">,</span><span class="s2">&quot;num_validation&quot;</span><span class="p">,</span> <span class="s2">&quot;num_test&quot;</span><span class="p">])</span>
                        <span class="p">]</span>


                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;elapse_time&quot;</span><span class="p">):</span>
                            <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
                        <span class="k">elif</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;.*_(acc|loss)&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="n">records</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;No record. Not stored in archive.&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">showTraining</span><span class="p">):</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Training:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">preps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_procedure</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">preps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preps</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples_per_epoch</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;samples_per_epoch = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples_per_epoch</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">showValidation</span><span class="p">):</span>
            <span class="n">out_str</span> <span class="o">+</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Validation:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;validation_split = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_split</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_procedure</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="n">preps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>
                    <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preps</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_val_samples</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;nb_val_samples = </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_val_samples</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">showCompilation</span><span class="p">):</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Compilation:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="n">_listIfNotNone</span><span class="p">([</span><span class="s2">&quot;optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_weight_mode&quot;</span><span class="p">])</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">showFit</span><span class="p">):</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;Fit:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">fits</span> <span class="o">=</span> <span class="n">_listIfNotNone</span><span class="p">([</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="s2">&quot;nb_epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;callbacks&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;validation_split&quot;</span><span class="p">,</span> <span class="s2">&quot;validation_data&quot;</span><span class="p">,</span> <span class="s2">&quot;shuffle&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;class_weight&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_weight&quot;</span><span class="p">])</span>
            <span class="n">out_str</span> <span class="o">+=</span> <span class="n">indent</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span>
        <span class="k">return</span> <span class="n">out_str</span></div>


<div class="viewcode-block" id="KerasTrial.from_json"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.KerasTrial.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">json_str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;trial&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reconsitute a KerasTrial object from its json string&#39;&#39;&#39;</span>
        <span class="n">kargs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">INPUT_DEFAULTS</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kargs</span><span class="p">):</span>
                <span class="n">kargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">INPUT_DEFAULTS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">trial</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">archive_dir</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kargs</span>
                <span class="c1"># model = d.get(&#39;model&#39;, None),</span>
                <span class="c1"># train_procedure=d.get(&#39;train_procedure&#39;, None),</span>
                <span class="c1"># samples_per_epoch=d.get(&#39;samples_per_epoch&#39;, None),</span>
                <span class="c1"># validation_split=d.get(&#39;validation_split&#39;, INPUT_DEFAULTS[&#39;validation_split&#39;]),</span>
                <span class="c1"># val_procedure=d.get(&#39;val_procedure&#39;, None),</span>
                <span class="c1"># nb_val_samples=d.get(&#39;nb_val_samples&#39;, INPUT_DEFAULTS[&#39;nb_val_samples&#39;]),</span>

                <span class="c1"># optimizer=d.get(&#39;optimizer&#39;, None),</span>
                <span class="c1"># loss=d.get(&#39;loss&#39;, None),</span>
                <span class="c1"># metrics=d.get(&#39;metrics&#39;, []),</span>
                <span class="c1"># sample_weight_mode=d.get(&#39;sample_weight_mode&#39;, INPUT_DEFAULTS[&#39;sample_weight_mode&#39;]),</span>
                <span class="c1"># batch_size=d.get(&#39;batch_size&#39;, INPUT_DEFAULTS[&#39;batch_size&#39;]),</span>
                <span class="c1"># nb_epoch=d.get(&#39;nb_epoch&#39;, INPUT_DEFAULTS[&#39;nb_epoch&#39;]),</span>
                <span class="c1"># callbacks=d.get(&#39;callbacks&#39;, INPUT_DEFAULTS[&#39;callbacks&#39;]),</span>

                <span class="c1"># max_q_size=d.get(&#39;max_q_size&#39;, INPUT_DEFAULTS[&#39;max_q_size&#39;]),</span>
                <span class="c1"># nb_worker=d.get(&#39;nb_worker&#39;,  INPUT_DEFAULTS[&#39;nb_worker&#39;]),</span>
                <span class="c1"># pickle_safe=d.get(&#39;pickle_safe&#39;, INPUT_DEFAULTS[&#39;pickle_safe&#39;]),</span>

                <span class="c1"># shuffle=d.get(&#39;shuffle&#39;, INPUT_DEFAULTS[&#39;shuffle&#39;]),</span>
                <span class="c1"># class_weight=d.get(&#39;class_weight&#39;,  INPUT_DEFAULTS[&#39;class_weight&#39;]),</span>
                <span class="c1"># sample_weight=d.get(&#39;sample_weight&#39;, INPUT_DEFAULTS[&#39;sample_weight&#39;])</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">trial</span></div></div>
        

<span class="c1">#TODO: Stopping Callbacks can&#39;t infer mode -&gt; only auto works</span>
<div class="viewcode-block" id="encode_callback"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.encode_callback">[docs]</a><span class="k">def</span> <span class="nf">encode_callback</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Encodes callbacks so that they can be decoded later&#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">EarlyStopping</span>
    <span class="kn">from</span> <span class="nn">CMS_Deep_Learning.callbacks</span> <span class="k">import</span> <span class="n">OverfitStopping</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">EarlyStopping</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">monitor</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">patience</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">OverfitStopping</span><span class="p">)):</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OverfitStopping&quot;</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;comparison_monitor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">comparison_monitor</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;max_percent_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">max_percent_diff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;EarlyStopping&quot;</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">c</span></div>
    




<div class="viewcode-block" id="decode_callback"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.decode_callback">[docs]</a><span class="k">def</span> <span class="nf">decode_callback</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Decodes callbacks into usable objects&#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">EarlyStopping</span>
    <span class="kn">from</span> <span class="nn">CMS_Deep_Learning.callbacks</span> <span class="k">import</span> <span class="n">OverfitStopping</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;OverfitStopping&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OverfitStopping</span><span class="p">(</span>  <span class="n">monitor</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">],</span>
                                    <span class="n">comparison_monitor</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;comparison_monitor&#39;</span><span class="p">],</span>
                                    <span class="n">max_percent_diff</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;max_percent_diff&#39;</span><span class="p">],</span>
                                    <span class="n">patience</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">],</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">],</span>
                                    <span class="n">mode</span> <span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">])</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;EarlyStopping&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">EarlyStopping</span><span class="p">(</span>   <span class="n">monitor</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">],</span>
                                    <span class="n">patience</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">],</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">],</span>
                                    <span class="n">mode</span> <span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="compute_hash"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.compute_hash">[docs]</a><span class="k">def</span> <span class="nf">compute_hash</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Computes a SHA1 hash string from a json string or Storable&#39;&#39;&#39;</span>
    <span class="n">hashable_str</span> <span class="o">=</span> <span class="n">inp</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">Storable</span><span class="p">)):</span>
        <span class="n">hashable_str</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">to_hashable</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hashable_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="split_hash"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.split_hash">[docs]</a><span class="k">def</span> <span class="nf">split_hash</span><span class="p">(</span><span class="n">hashcode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Splits a SHA1 hash string into two strings. One with the first 2 characters and another with the rest&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">hashcode</span><span class="p">[:</span><span class="n">HASH_SPLIT_POINT</span><span class="p">],</span> <span class="n">hashcode</span><span class="p">[</span><span class="n">HASH_SPLIT_POINT</span><span class="p">:]</span></div>

<div class="viewcode-block" id="get_blob_path"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.get_blob_path">[docs]</a><span class="k">def</span> <span class="nf">get_blob_path</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Blob path (archive location) from either (storable,archive_dir), (hashcode, archive_dir), or</span>
<span class="sd">        (json_str=?, archive_dir=?)&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Storable</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">split_hash</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">hash</span><span class="p">())</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
            <span class="n">hashcode</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">return</span> <span class="n">split_hash</span><span class="p">(</span><span class="n">hashcode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown datatype at 1st argument&quot;</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">blob_dir</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">_helper</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="s1">&#39;archive_dir&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;archive_dir&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trial Directory was not specified&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">blob_dir</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">_helper</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;json_str&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;THIS HAPPENS&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;using json_str is depricated&quot;</span><span class="p">)</span>
                <span class="n">hashcode</span> <span class="o">=</span> <span class="n">compute_hash</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;json_str&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;hashcode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">hashcode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hashcode&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No hashcode or trial specified&quot;</span><span class="p">)</span>
            <span class="n">blob_dir</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">split_hash</span><span class="p">(</span><span class="n">hashcode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Too Many arguments&quot;</span><span class="p">)</span>

    <span class="n">blob_path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">archive_dir</span><span class="p">,</span><span class="s2">&quot;blob&quot;</span><span class="p">,</span> <span class="n">blob_dir</span><span class="p">,</span><span class="n">blob</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">blob_path</span></div>


<div class="viewcode-block" id="read_data_archive"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.read_data_archive">[docs]</a><span class="k">def</span> <span class="nf">read_data_archive</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns the data archive read from the trial directory&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">read_json_obj</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s1">&#39;data_archive.json&#39;</span><span class="p">)</span></div>
<div class="viewcode-block" id="write_data_archive"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.write_data_archive">[docs]</a><span class="k">def</span> <span class="nf">write_data_archive</span><span class="p">(</span><span class="n">data_archive</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Writes the data archive to the trial directory&#39;&#39;&#39;</span>
    <span class="n">write_json_obj</span><span class="p">(</span><span class="n">data_archive</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="s1">&#39;data_archive.json&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="read_json_obj"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.read_json_obj">[docs]</a><span class="k">def</span> <span class="nf">read_json_obj</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a json object read from the given directory&#39;&#39;&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">]),</span> <span class="s2">&quot;r&quot;</span> <span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully loaded </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to load </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="write_json_obj"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.write_json_obj">[docs]</a><span class="k">def</span> <span class="nf">write_json_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Writes a json object to the given directory&#39;&#39;&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="nb">open</span><span class="p">(</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">]),</span> <span class="s2">&quot;w&quot;</span> <span class="p">))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully wrote </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to write </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span></div>



<div class="viewcode-block" id="write_object"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.write_object">[docs]</a><span class="k">def</span> <span class="nf">write_object</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Writes an object from the given data with the given filename in the given directory&#39;&#39;&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sucessfully wrote </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to write </span><span class="si">%r</span><span class="s1"> at </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>





<span class="c1">#Reading Trials</span>

<div class="viewcode-block" id="get_all_data"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.get_all_data">[docs]</a><span class="k">def</span> <span class="nf">get_all_data</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Gets all the DataProcedure in the data_archive&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">get_data_by_function</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_data_by_function"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.get_data_by_function">[docs]</a><span class="k">def</span> <span class="nf">get_data_by_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Gets a list of DataProcedure that use a certain function&#39;&#39;&#39;</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">func_module</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">func_module</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
        <span class="n">t_func</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">t_module</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;func_module&quot;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">t_func</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">func_module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">func_module</span><span class="p">,</span> <span class="n">t_module</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">DataProcedure</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">dp</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_all_trials"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.get_all_trials">[docs]</a><span class="k">def</span> <span class="nf">get_all_trials</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get all the trials listed in the trial_record&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">get_trials_by_name</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">archive_dir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_trials_by_name"><a class="viewcode-back" href="../../../storage.html#CMS_Deep_Learning.storage.archiving.get_trials_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_trials_by_name</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">assert_complete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get all the trials with a particluar name or that match a given regular expression&#39;&#39;&#39;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">KerasTrial</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">%r</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="n">t_name</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">t_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">unicode</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t_name</span><span class="p">]:</span>
            <span class="n">trial</span> <span class="o">=</span> <span class="n">KerasTrial</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">trial</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">assert_complete</span> <span class="ow">or</span> <span class="n">trial</span><span class="o">.</span><span class="n">is_complete</span><span class="p">())):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CMS_Deep_Learning 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Daniel Phillip Weitekamp.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>